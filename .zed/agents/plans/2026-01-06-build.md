# Implement cargo docmd build Command - Master Overview

This is the master plan for implementing the `cargo docmd build` command. The
original monolithic plan has been split into multiple focused sub-plans to make
the work manageable and allow for iterative implementation.

## Plan Split Strategy

The original plan covered too much ground for a single task. The implementation
has been split into focused sub-plans that can be executed independently:

1. **Infrastructure First**: Establish the core build command and markdown
   framework
2. **Generators by Category**: Group markdown generators by related
   functionality
3. **Incremental Delivery**: Each plan produces working, testable code

## Sub-Plans

Execute the plans in this order:

### 1. Core Infrastructure

**File**: `2026-01-07-build-infrastructure.md`

Establish the foundation for the build command:

- Rename `generate` to `build` command
- Implement cargo rustdoc execution
- Add nightly toolchain verification
- Parse rustdoc JSON
- Create output directory management
- Implement error handling

**Dependencies**: None **Output**: Working build command that can execute cargo
rustdoc and parse JSON

### 2. Markdown Framework

**File**: `2026-01-07-markdown-framework.md`

Create the infrastructure for markdown generation:

- Module structure for markdown generators
- File naming convention
- Common markdown utilities
- Index page generator
- File writing utilities

**Dependencies**: Core infrastructure **Output**: Framework ready for generator
implementation

### 3. Basic Type Generators

**File**: `2026-01-07-generators-basic-types.md`

Implement generators for fundamental data types:

- Struct generator
- Enum generator
- Union generator
- Type alias generator

**Dependencies**: Markdown framework **Output**: Markdown generation for basic
data structures

### 4. Trait and Function Generators

**File**: `2026-01-07-generators-traits-functions.md`

Implement generators for behavioral types:

- Trait generator
- Function generator
- Impl block generator
- Associated constant generator

**Dependencies**: Markdown framework **Output**: Markdown generation for traits,
functions, and implementations

### 5. Advanced Type Generators

**File**: `2026-01-07-generators-advanced-types.md`

Implement generators for remaining item types:

- Module generator
- Macro generator (declarative and procedural)
- Static item generator
- Trait alias generator
- Extern crate generator
- Use item generator
- Primitive type generator
- Extern type generator

**Dependencies**: Markdown framework **Output**: Complete coverage of all 21
rustdoc item types

## Implementation Order

Execute plans sequentially:

1. **Core Infrastructure** â†’ Get build command working
2. **Markdown Framework** â†’ Create generator infrastructure
3. **Basic Types** â†’ First set of working generators (can start seeing results)
4. **Traits and Functions** â†’ Behavioral type generators
5. **Advanced Types** â†’ Remaining specialized generators

After each plan completion, run `cargo test` to ensure everything works.

## Cross-Cutting Considerations

### Code Style

- Follow the Rust Coding Guidelines in `AGENTS.md`
- Use descriptive variable names (no abbreviations like `ty`, `msg`, `cfg`)
- Favor linear control flow over nesting
- Separate data extraction from validation

### Documentation

- Update `DOCS.md` after each plan
- Add module-level documentation to all new files
- Keep doc comments focused on "what" and "why", not "how"

### Testing

- Write unit tests for each generator
- Group tests by behavior with comment separators
- Use descriptive test names with prefixes (e.g., `execution_`, `error_`)
- Run `cargo test` after each plan

### Error Handling

- Provide clear, actionable error messages
- Include full paths in file operation errors
- Give installation suggestions for missing dependencies
- Use centralized error types from `src/error.rs` with `Result<T>` alias

## Success Criteria (Overall)

- [ ] All 5 sub-plans completed
- [ ] `cargo docmd build --crate <name>` works for any crate
- [ ] Markdown files generated in `$CARGO_TARGET_DIR/docmd`
- [ ] All 21 rustdoc item types have generators
- [ ] Index page lists all items with links
- [ ] All generated files follow consistent naming convention
- [ ] All tests pass
- [ ] No compiler warnings
- [ ] Documentation is complete and accurate

## Item Types to Handle

All 21 variants from `rustdoc_types::ItemEnum`:

| Type        | Generator Plan                |
| ----------- | ----------------------------- |
| Module      | Advanced Types                |
| ExternCrate | Advanced Types                |
| Use         | Advanced Types                |
| Union       | Basic Types                   |
| Struct      | Basic Types                   |
| StructField | Generated by Struct generator |
| Enum        | Basic Types                   |
| Variant     | Generated by Enum generator   |
| Function    | Traits and Functions          |
| Trait       | Traits and Functions          |
| TraitAlias  | Advanced Types                |
| Impl        | Traits and Functions          |
| TypeAlias   | Basic Types                   |
| Constant    | Traits and Functions          |
| Static      | Advanced Types                |
| ExternType  | Advanced Types                |
| Macro       | Advanced Types                |
| ProcMacro   | Advanced Types                |
| Primitive   | Advanced Types                |
| AssocConst  | Generated by Impl generator   |
| AssocType   | Generated by Impl generator   |

## File Structure After Completion

```
cargo-docmd/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.rs                 # Updated Command enum (Build)
â”‚   â”œâ”€â”€ error.rs                # Centralized error definitions
â”‚   â”œâ”€â”€ cargo.rs                # Cargo command execution
â”‚   â”œâ”€â”€ markdown/               # Markdown generation framework
â”‚   â”‚   â”œâ”€â”€ mod.rs              # Module exports
â”‚   â”‚   â”œâ”€â”€ index.rs            # Index page generator
â”‚   â”‚   â”œâ”€â”€ utils.rs            # Common utilities
â”‚   â”‚   â”œâ”€â”€ struct_.rs          # Struct generator
â”‚   â”‚   â”œâ”€â”€ enum_.rs            # Enum generator
â”‚   â”‚   â”œâ”€â”€ union.rs            # Union generator
â”‚   â”‚   â”œâ”€â”€ alias.rs            # Type alias generator
â”‚   â”‚   â”œâ”€â”€ trait_.rs           # Trait generator
â”‚   â”‚   â”œâ”€â”€ function.rs         # Function generator
â”‚   â”‚   â”œâ”€â”€ impl_.rs            # Impl block generator
â”‚   â”‚   â”œâ”€â”€ constant.rs         # Constant generator
â”‚   â”‚   â”œâ”€â”€ module.rs           # Module generator
â”‚   â”‚   â”œâ”€â”€ macro.rs            # Macro generator
â”‚   â”‚   â”œâ”€â”€ static_item.rs      # Static generator
â”‚   â”‚   â”œâ”€â”€ trait_alias.rs      # Trait alias generator
â”‚   â”‚   â”œâ”€â”€ extern_crate.rs     # Extern crate generator
â”‚   â”‚   â”œâ”€â”€ use_item.rs         # Use item generator
â”‚   â”‚   â”œâ”€â”€ primitive.rs        # Primitive generator
â”‚   â”‚   â””â”€â”€ extern_type.rs      # Extern type generator
â”‚   â””â”€â”€ commands/
â”‚       â”œâ”€â”€ mod.rs              # Module exports
â”‚       â”œâ”€â”€ browse.rs           # Browse command
â”‚       â””â”€â”€ build.rs            # Build command (renamed from generate.rs)
```

## Current Status

- [x] Plan split completed
- [x] Core Infrastructure: âœ… COMPLETED
- [x] Markdown Framework: âœ… COMPLETED
- [ ] Basic Type Generators: ðŸŸ¡ NOT STARTED
- [ ] Trait and Function Generators: ðŸŸ¡ NOT STARTED
- [ ] Advanced Type Generators: ðŸŸ¡ NOT STARTED

## Notes

Refer to individual plan files for detailed implementation steps, test plans,
and design considerations.

## Implementation Notes

### Core Infrastructure - Completed âœ…

The Core Infrastructure plan (2026-01-07-build-infrastructure.md) has been
completed successfully. Key accomplishments:

1. **Command rename**: `generate` command renamed to `build` throughout codebase
2. **Centralized error handling**: Created `src/error.rs` with `Error`,
   `BuildError`, and `MarkdownError` enums, plus `Result<T>` type alias
3. **Cargo execution**: Implemented `check_nightly_installed()` and
   `generate_rustdoc_json()` in `src/cargo.rs`
4. **Build command**: Fully functional `build()` command that:
    - Checks for nightly toolchain
    - Executes cargo rustdoc
    - Parses JSON output
    - Logs item counts by type
5. **Output directory**: Uses `$CARGO_TARGET_DIR/docmd` for consistent output
6. **Documentation**: Updated README.md and DOCS.md with build command
7. **Tests**: 2 meaningful unit tests for error handling paths

**Simplifications made during implementation**:

- Removed complex file searching logic in `generate_rustdoc_json()`
- Function now simply constructs expected path: `target/doc/crate_name.json`
- Error handling occurs appropriately during JSON parsing
- Removed unnecessary tests that didn't verify meaningful behavior

**Code quality**:

- All doc comments follow Rust coding guidelines (no Arguments/Returns sections)
- Removed "interactive" terminology from documentation
- Linear control flow throughout
- Descriptive variable names

**Verification**:

```shell
cargo docmd build --crate serde  # Works, logs 32 items
cargo docmd build --crate docmd  # Works, logs 177 items
cargo test                     # All 2 tests pass
```

### Markdown Framework - Completed âœ…

The Markdown Framework plan (2026-01-06-markdown-framework.md) has been
completed successfully. Key accomplishments:

1. **Module structure established**:
    - `src/markdown/mod.rs`: Module exports and constants
    - `src/markdown/index.rs`: Index page generator
    - `src/markdown/utils.rs`: Common utilities and shared functions

2. **Common utilities implemented**:
    - `get_item_type_name()`: Shared utility for all item type names
    - `generate_filename()`: File naming with hyphen replacement
    - `render_header()`, `render_code_block()`, `render_inline_code()`
    - `render_documentation()`, `render_next_actions_section()`
    - `write_markdown_file()`, `ensure_directory_exists()`

3. **Index page generator**:
    - `generate_index()`: Creates comprehensive index.md
    - `group_items_by_type()`: Organizes items by type
    - Includes crate documentation, item counts, and links
    - Skips root module and private items

4. **File naming convention**:
    - Replaces `::` with `-` throughout item paths
    - Strips generic parameters (e.g., `<K, V>`)
    - Adds `.md` extension
    - Deterministic and filesystem-safe

5. **File writing utilities**:
    - Creates parent directories recursively
    - Handles existing directories gracefully
    - Error messages include full paths

6. **Enhancements made during implementation**:
    - Enhanced JSON filename finding in `cargo.rs` with partial matching
    - Fixed nightly check to always return `NightlyNotInstalled`
    - Consolidated test modules to single `mod tests` per file
    - Removed 6 tests that only verified language guarantees
    - Added clarifying comments for filename tests

**Code quality**:

- Follows Rust Coding Guidelines from AGENTS.md
- Descriptive variable names (no abbreviations)
- Linear control flow with guard clauses
- Single `mod tests` per file with behavior prefixes
- Doc comments are concise paragraphs

**Test coverage**:

- 41 passing tests (all meaningful behavior)
- Tests grouped by: Filename, Rendering, Error Handling
- Tests use descriptive prefixes (`filename_`, `render_`, `error_handling_`)
- Integration tests for index generation

**Verification**:

```shell
cargo test                     # 41 tests pass
cargo run -- build --crate serde  # Generates index.md
cargo run -- build --crate docmd  # Generates index.md
```

**Files created**:

- `src/markdown/mod.rs` (22 lines)
- `src/markdown/index.rs` (224 lines)
- `src/markdown/utils.rs` (398 lines)
- Updated `DOCS.md` with markdown format documentation
- Updated `AGENTS.md` with clarified Guideline #5

The framework is ready for implementing the 21 item-type generators!
