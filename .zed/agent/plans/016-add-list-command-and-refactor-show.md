---
type: normal
title: "Add list command and refactor show command"
seq: 016
slug: "add-list-command-and-refactor-show"
created: "2025-01-09T12:00:00Z"
status: completed
---

# Add list command and refactor show command

The current `show` command displays `all.md` (master index of all items) when
given a crate name. This introduces confusion because `all.md` is a
comprehensive list of all crate items, while `index.md` provides a better crate
overview. This plan adds a new `list` command to show `all.md` and refactors
`show` to use `index.md` for crate-level requests.

## Current Problems

The `show` command behavior is counterintuitive for crate-level requests:

```rust
// Current behavior in show.rs
fn resolve_markdown_path(parsed: &ParsedItemPath) -> Result<PathBuf> {
    let parsed_item = match &parsed.item {
        None => {
            let all_md = crate_docmd_dir.join("all.md");  // Shows ALL items
            return Ok(all_md);
        }
        Some(item) => item,
    };
    // ... looks up specific item
}
```

When users run `cargo txt show serde`, they expect a crate overview (index.md),
not a complete master index (all.md). The master index is more appropriate as a
separate "list all items" operation.

Additionally, there's no dedicated command to list all items in a crate, forcing
users to use `show` which has ambiguous behavior.

## Proposed Solution

1. Create a new `list` command that only accepts crate names and displays
   `all.md`
2. Refactor `show` command to display `index.md` for crate-level requests
3. Add validation in `list` command to reject paths containing `::`
4. Update CLI help text and documentation to clarify command differences

## Analysis Required

### Dependency Investigation

- [ ] Review `show.rs` implementation to understand path resolution logic
- [ ] Verify `index.md` is always generated by `build` command
- [ ] Check error handling patterns in existing commands

### Code Locations to Check

- `src/commands/show.rs` - Current implementation using `all.md`
- `src/commands/build.rs` - Verify `index.md` generation
- `src/main.rs` - CLI command structure and argument parsing

## Implementation Checklist

### Code Changes

#### Create New List Command

- [x] Create `src/commands/list.rs` with new `list` function
- [x] Implement crate-only validation (reject paths with `::`)
- [x] Add path resolution to `all.md` in `list.rs`
- [x] Call `build::if_needed(&crate_name)` to auto-build when needed
- [x] Add comprehensive error messages for invalid input

#### Refactor Show Command

- [x] Update `src/commands/show.rs` to use `index.md` when item is None
- [x] Update doc comments to reflect index.md usage for crate requests
- [x] Update debug log messages for clarity
- [x] Replace local `build_if_needed` function with call to `build::if_needed`
- [x] Verify existing tests still pass or update as needed

#### Update Main and Module Exports

- [x] Update `src/main.rs`: Add `Command::List` variant with crate_name argument
- [x] Update `src/main.rs`: Add list command description in help text
- [x] Update `src/main.rs`: Add match arm for `Command::List { crate_name }`
- [x] Update `src/main.rs`: Add list import: `commands::{build, show, list}`
- [x] Update `src/commands/mod.rs`: Add `pub mod list;`
- [x] Update `src/commands/mod.rs`: Add `pub use list::list;`

#### Extract build_if_needed to Build Module

- [x] Move `build_if_needed` function from `src/commands/show.rs` to
      `src/commands/build.rs`
- [x] Rename function to `pub fn if_needed(crate_name: &str)` in build module
- [x] Update signature to accept crate_name directly instead of ParsedItemPath
- [x] Export the function in `src/commands/mod.rs`
- [x] Update `src/commands/show.rs` to call
      `build::if_needed(&parsed.crate_name)`
- [x] Add unit tests for `build::if_needed` in build.rs

#### Add Tests for List Command

- [x] Add tests for valid crate names
- [x] Add tests for invalid paths with `::`
- [x] Add tests for edge cases (empty string, multiple separators)

### Documentation Updates

#### Update README.md

- [x] Add "List Command" section describing new list command
- [x] Update "Show Command" section to clarify it uses index.md
- [x] Update show command examples to use index.md for crate requests
- [x] Add list command examples showing all.md usage
- [x] Update "Current Status" section to mention list command
- [x] Update agent instruction to include list command
- [x] Update "Features" section to mention list command

#### Update DOCS.md

- [x] Add "### list" section with full command documentation
- [x] Update "### show" section to clarify index.md usage
- [x] Update show examples to reflect new behavior
- [x] Add list examples showing crate-only validation
- [x] Update error handling section to include list errors

### Test Updates

- [x] Verify existing show command tests still pass
- [x] Run `cargo test` to verify all tests pass
- [x] Test `cargo txt list serde` displays all.md
- [x] Test `cargo txt show serde` displays index.md
- [x] Test `cargo txt list serde::Error` fails with appropriate error
- [x] Test `cargo txt show serde::Error` still works

## Test Plan

### Verification Tests

- [x] Run `cargo build` to verify compilation succeeds
- [x] Run `cargo clippy` to verify no lint warnings or errors
- [x] Run `cargo txt --help` to verify both list and show commands appear
- [x] Run `cargo txt list --help` to verify list-specific help text
- [x] Run `cargo txt list serde` to verify it displays all.md content
- [x] Run `cargo txt show serde` to verify it displays index.md content
- [x] Run `cargo txt show serde::Error` to verify item-specific display still
      works
- [x] Run `cargo txt list serde::Error` to verify it fails with appropriate
      error message

### Regression Tests

- [x] Verify auto-build still triggers for both list and show when docs don't
      exist
- [x] Verify build command still generates both index.md and all.md
- [x] Verify error messages are clear and helpful
- [x] Test with multiple crates to ensure behavior is consistent

## Structure After Changes

### File Structure

```
src/
├── commands/
│   ├── build.rs       # Added if_needed() function
│   ├── show.rs        # Updated to use index.md and build::if_needed()
│   ├── list.rs        # New file
│   └── mod.rs         # Updated exports
├── main.rs            # Updated CLI definition
└── ...
```

### CLI Usage After Changes

```rust
// BEFORE
cargo txt show serde           // Shows all.md
cargo txt show serde::Error    // Shows item doc

// AFTER
cargo txt list serde           // Shows all.md (master index of all items)
cargo txt show serde           // Shows index.md (crate overview)
cargo txt show serde::Error    // Shows item doc
```

### Show.rs Changes

```rust
// BEFORE
fn resolve_markdown_path(parsed: &ParsedItemPath) -> Result<PathBuf> {
    let parsed_item = match &parsed.item {
        None => {
            let all_md = crate_docmd_dir.join("all.md");
            return Ok(all_md);
        }
        Some(item) => item,
    };
    // ...
}

// AFTER
fn resolve_markdown_path(parsed: &ParsedItemPath) -> Result<PathBuf> {
    let parsed_item = match &parsed.item {
        None => {
            let index_md = crate_docmd_dir.join("index.md");
            trace!("No item specified, returning index.md: {:?}", index_md);
            return Ok(index_md);
        }
        Some(item) => item,
    };
    // ...
}
```

### Build.rs Changes

```rust
// NEW FUNCTION in build.rs
/// Build documentation for a crate if needed.
///
/// Checks if the all.md file exists for the crate. If not, triggers
/// a build to generate all markdown files.
pub fn if_needed(crate_name: &str) -> Result<()> {
    let metadata = cargo::metadata()?;
    let all_md_path = PathBuf::from(&metadata.target_directory)
        .join("docmd")
        .join(crate_name)
        .join("all.md");

    if all_md_path.exists() {
        debug!("Documentation exists at {:?}, skipping build", all_md_path);
        return Ok(());
    }

    info!(
        "Documentation not found, running build for {}",
        crate_name
    );
    build(crate_name)?;

    Ok(())
}
```

### List.rs Implementation Structure

```rust
// src/commands/list.rs
pub fn list(crate_name: &str) -> Result<()> {
    // Validate crate_name contains no ::
    // Call build::if_needed(&crate_name)
    // Resolve to all.md
    // Display content
}

#[cfg(test)]
mod tests {
    // Tests for crate name validation
}
```

## Design Considerations

1. **Command naming**: "list" clearly communicates it shows a list of all items,
   while "show" focuses on viewing documentation.
2. **Validation strategy**: `list` command should reject paths with `::` early
   to provide clear error messages.
3. **Code reuse**: Extract `build_if_needed` from show.rs to build.rs as
   `build::if_needed()` to eliminate duplication between list and show commands.
4. **Backward compatibility**: This is a breaking change. Users relying on
   `show serde` displaying all.md will see different output. Update
   documentation clearly.

## Success Criteria

- `cargo txt list serde` successfully displays all.md
- `cargo txt show serde` successfully displays index.md
- `cargo txt list serde::Error` fails with clear error message about crate-only
  input
- `cargo txt show serde::Error` still works as before
- Help text clearly distinguishes between list and show commands
- All tests pass (existing + new list command tests)
- `rust-lint` runs without errors or warnings
- README.md and DOCS.md clearly document both commands with examples

## Implementation Status: ✅ COMPLETED

## Implementation Notes

### Implementation Summary

Successfully implemented the list command and refactored the show command. All
objectives were achieved without issues.

### Key Implementation Details

1. **List Command (`src/commands/list.rs`)**:
    - Created comprehensive validation function `validate_crate_name()` that
      rejects paths with `::`
    - Implemented clear error messages suggesting use of show command for
      item-specific requests
    - Added 10 unit tests covering valid crate names, invalid paths, and edge
      cases
    - Used `build::if_needed()` for auto-build functionality

2. **Show Command Refactoring**:
    - Updated `resolve_markdown_path()` to return `index.md` instead of `all.md`
      for crate-level requests
    - Updated module docstring to clarify it displays crate overview (index.md)
      or specific items
    - Updated trace log message to reference index.md
    - Removed local `build_if_needed()` function, now calls
      `build::if_needed(&parsed.crate_name)`

3. **Build Module Enhancement**:
    - Added `if_needed()` function that checks for `all.md` existence and
      triggers build if missing
    - Simplified signature to accept `crate_name: &str` directly
    - Added note in tests that full integration tests would be better suited for
      `tests/` directory

4. **Main and Module Updates**:
    - Added `Command::List` variant with crate_name argument in `src/main.rs`
    - Added list command description and match arm
    - Updated imports to include `list` module
    - Exported list module in `src/commands/mod.rs`

5. **Documentation Updates**:
    - Updated README.md with comprehensive list command section
    - Updated show command section to clarify index.md usage
    - Updated agent instruction to include list command example
    - Updated DOCS.md with full list command documentation
    - Updated show command behavior description

### Testing Results

- All 53 tests pass (43 existing + 10 new list command tests)
- No clippy warnings
- Manual verification confirmed:
    - `cargo txt list serde` displays all.md (master index)
    - `cargo txt show serde` displays index.md (crate overview)
    - `cargo txt show serde::Error` displays specific item documentation
    - `cargo txt list serde::Error` fails with helpful error message
    - Auto-build functionality works for both commands

### Code Quality

- Followed Rust Coding Guidelines from AGENTS.md
- Used appropriate error types with anyhow for consistent error handling
- Added comprehensive logging with trace/debug/info levels
- Maintained consistency with existing codebase style
- Added descriptive doc comments for all public functions

### No Issues Encountered

Implementation proceeded smoothly without any unexpected issues or
complications. The design decisions in the plan were sound and the
implementation matched expectations.
